# 技術設計・アーキテクチャ

## 仮定一覧

本設計書は以下の仮定に基づいて作成しています。

| # | 仮定項目 | 内容 |
|---|---------|------|
| 1 | プロダクト種別 | AIを活用した中小企業向け業務効率化SaaSプラットフォーム |
| 2 | 主要機能 | 請求書処理（OCR＋データ抽出）、契約書管理（リスク分析＋要約）、議事録自動生成（音声→テキスト→要約） |
| 3 | ターゲット市場 | 日本国内の中小企業（従業員10〜300名規模） |
| 4 | 言語要件 | 日本語特化のNLP処理が必須。UIも日本語ファースト |
| 5 | マルチテナント | SaaS型マルチテナントアーキテクチャを採用 |
| 6 | 初期ユーザー規模 | ローンチ時100社、1年後1,000社を想定 |
| 7 | コンプライアンス | 個人情報保護法、電子帳簿保存法への準拠が必要 |
| 8 | チーム規模 | 開発チーム5〜10名でのスタートを想定 |
| 9 | クラウド基盤 | AWSを主要クラウドプロバイダーとして採用（東京リージョン） |
| 10 | 予算制約 | スタートアップフェーズのため、初期コスト最適化を重視 |

---

## 1. システムアーキテクチャ概要

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                        クライアント層                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  Webアプリ    │  │ モバイルWeb   │  │  外部連携     │              │
│  │  (React SPA) │  │ (PWA対応)    │  │  (API利用)   │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└─────────┼─────────────────┼─────────────────┼───────────────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     API Gateway / CDN層                              │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  Amazon CloudFront + API Gateway                         │       │
│  │  - レート制限、認証トークン検証、リクエストルーティング       │       │
│  └──────────────────────────┬────────────────────────────────┘       │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    アプリケーション層 (ECS Fargate)                   │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  認証サービス  │  │ テナント管理  │  │ 通知サービス  │              │
│  │  (Auth)      │  │ (Tenant)     │  │ (Notify)     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 請求書処理    │  │ 契約書管理    │  │ 議事録生成    │              │
│  │ (Invoice)    │  │ (Contract)   │  │ (Minutes)    │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  BFF (Backend for Frontend) - GraphQL API                │       │
│  └──────────────────────────────────────────────────────────┘       │
└─────────────────────────────┬───────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   AI/ML層        │ │   データ層        │ │  非同期処理層     │
│                  │ │                  │ │                  │
│ ・Claude API     │ │ ・PostgreSQL     │ │ ・Amazon SQS     │
│  (LLM処理)      │ │  (RDS Aurora)   │ │ ・EventBridge    │
│ ・Amazon         │ │ ・Redis          │ │ ・Step Functions │
│  Textract       │ │  (ElastiCache)  │ │                  │
│  (OCR)          │ │ ・S3             │ └──────────────────┘
│ ・Amazon         │ │  (ファイル保存)  │
│  Transcribe     │ │ ・OpenSearch     │
│  (音声認識)      │ │  (全文検索)      │
│                  │ └──────────────────┘
└──────────────────┘
```

### 1.2 マイクロサービス構成

| サービス名 | 責務 | 通信方式 |
|-----------|------|---------|
| Auth Service | 認証・認可、セッション管理 | REST (同期) |
| Tenant Service | テナント管理、プラン管理、利用量計測 | REST (同期) |
| Invoice Service | 請求書アップロード、OCR処理、データ抽出 | REST + SQS (非同期) |
| Contract Service | 契約書管理、リスク分析、要約生成 | REST + SQS (非同期) |
| Minutes Service | 音声アップロード、文字起こし、議事録生成 | REST + SQS (非同期) |
| Notification Service | メール・Slack通知、処理完了通知 | SQS (非同期) |
| BFF (GraphQL) | フロントエンド向けAPI集約、データ変換 | GraphQL (同期) |

### 1.3 サービス間通信

- **同期通信**: サービス間のリアルタイムデータ取得にはgRPCを使用（内部通信）
- **非同期通信**: AI処理など時間のかかるタスクはAmazon SQSキューを介して非同期実行
- **イベント駆動**: Amazon EventBridgeによるイベントバスでサービス間の疎結合を実現

---

## 2. 技術スタック選定と理由

### 2.1 フロントエンド

| 技術 | 選定理由 |
|------|---------|
| **Next.js (App Router)** | SSR/SSGによるSEO対応、React Server Componentsによるパフォーマンス最適化。日本の開発者コミュニティも大きく採用実績が豊富 |
| **TypeScript** | 型安全性による開発品質向上。チーム開発でのコード品質担保に不可欠 |
| **Tailwind CSS** | ユーティリティファーストで高速なUI開発。デザインシステムとの親和性が高い |
| **shadcn/ui** | アクセシビリティ対応済みのコンポーネントライブラリ。カスタマイズ性が高く、業務アプリに最適 |
| **TanStack Query** | サーバー状態管理。キャッシュ、再フェッチ、楽観的更新を効率的に実装 |
| **Zustand** | クライアント状態管理。軽量でシンプルなAPI |

### 2.2 バックエンド

| 技術 | 選定理由 |
|------|---------|
| **Node.js (NestJS)** | TypeScriptによるフルスタック統一。NestJSのモジュラーアーキテクチャはマイクロサービスとの相性が良い |
| **GraphQL (Apollo Server)** | BFF層での柔軟なデータ取得。フロントエンドの要件変更に強い |
| **Prisma** | 型安全なORM。マイグレーション管理が容易でマルチテナント対応も可能 |
| **BullMQ** | Redisベースのジョブキュー。AI処理の非同期実行に使用 |

### 2.3 インフラストラクチャ

| 技術 | 選定理由 |
|------|---------|
| **AWS (東京リージョン)** | 日本市場向けの低レイテンシー。電子帳簿保存法対応のためデータ国内保持が可能 |
| **ECS Fargate** | サーバーレスコンテナ実行。運用負荷の低減とオートスケーリング |
| **Aurora PostgreSQL** | マネージドRDB。高可用性とリードレプリカによる読み取りスケーリング |
| **ElastiCache (Redis)** | セッション管理、キャッシュ、ジョブキューのバックエンド |
| **S3** | ファイルストレージ。請求書画像・音声ファイル・契約書PDFの保存 |
| **CloudFront** | CDNによる静的アセット配信の高速化 |
| **Terraform** | IaCによるインフラ管理。環境の再現性と変更管理 |
| **GitHub Actions** | CI/CDパイプライン。コスト効率が良くGitHubとの統合が容易 |

### 2.4 AI/ML

| 技術 | 選定理由 |
|------|---------|
| **Claude API (Anthropic)** | 日本語性能が高いLLM。契約書分析・議事録要約・データ構造化に使用 |
| **Amazon Textract** | 日本語OCR対応。請求書・領収書からのデータ抽出に最適 |
| **Amazon Transcribe** | 日本語音声認識。会議音声の文字起こしに使用 |
| **Amazon Comprehend** | 日本語NLP。固有表現抽出・感情分析の補助に使用 |
| **LangChain** | LLMアプリケーションフレームワーク。プロンプト管理・チェーン構築を効率化 |

### 2.5 監視・運用

| 技術 | 選定理由 |
|------|---------|
| **Amazon CloudWatch** | AWSネイティブの監視・ログ管理 |
| **AWS X-Ray** | 分散トレーシング。マイクロサービス間のリクエスト追跡 |
| **Sentry** | アプリケーションエラー追跡。フロントエンド・バックエンド両対応 |
| **Datadog (Phase 2以降)** | 統合監視プラットフォーム。スケール後の高度な監視に導入 |

---

## 3. 主要機能の技術的実現方法

### 3.1 請求書処理（Invoice Processing）

```
[ユーザー] → 請求書画像アップロード
     │
     ▼
[BFF] → S3に画像保存 → SQSキューに処理リクエスト送信
     │
     ▼ (非同期)
[Invoice Service]
     │
     ├─① Amazon Textract で OCR処理
     │   └─ テキスト・テーブル・フォームデータ抽出
     │
     ├─② Claude API で構造化データ抽出
     │   └─ プロンプト: 抽出テキストから以下を特定
     │      ・発行元企業名、住所
     │      ・請求金額（税込/税抜）
     │      ・請求日、支払期限
     │      ・明細項目のリスト
     │
     ├─③ データ検証・補正
     │   └─ 金額計算の整合性チェック、日付フォーマット正規化
     │
     └─④ 結果をDBに保存 → 通知サービスで完了通知
```

**主要な技術的考慮事項**:
- Textractの結果をそのまま使わず、Claude APIで構造化することで精度を向上
- 処理結果に信頼度スコアを付与し、低スコアの場合は人間レビューを促す
- バッチアップロード対応（複数ファイルの一括処理）

### 3.2 契約書管理（Contract Management）

```
[ユーザー] → 契約書PDFアップロード
     │
     ▼
[BFF] → S3に保存 → SQSキューに処理リクエスト送信
     │
     ▼ (非同期)
[Contract Service]
     │
     ├─① PDF テキスト抽出（pdf-parse ライブラリ）
     │   └─ スキャンPDFの場合は Textract を使用
     │
     ├─② Claude API で契約書分析
     │   ├─ 要約生成（契約の要点を3〜5項目で要約）
     │   ├─ リスク分析（不利な条項の検出・ハイライト）
     │   ├─ 重要日付の抽出（契約開始日、終了日、更新日）
     │   └─ 当事者情報の抽出
     │
     ├─③ OpenSearch にインデックス登録
     │   └─ 全文検索・条項検索を可能にする
     │
     └─④ 結果をDBに保存 → 期限アラート設定
```

**主要な技術的考慮事項**:
- 契約書は機密性が高いため、テナント間のデータ分離を厳格に実施
- Claude APIへの送信時、個人情報のマスキング処理を検討
- 更新期限が近い契約の自動アラート（EventBridge Scheduler）

### 3.3 議事録自動生成（Meeting Minutes Generation）

```
[ユーザー] → 会議音声ファイルアップロード or リアルタイム録音
     │
     ▼
[BFF] → S3に音声保存 → SQS キューに処理リクエスト送信
     │
     ▼ (非同期)
[Minutes Service]
     │
     ├─① Amazon Transcribe で音声認識
     │   ├─ 日本語モデル使用
     │   ├─ 話者分離（Speaker Diarization）有効化
     │   └─ カスタム語彙（業界用語・社内用語）対応
     │
     ├─② Claude API で議事録生成
     │   ├─ 文字起こしテキストの整形・誤認識補正
     │   ├─ 議題ごとのセクション分け
     │   ├─ 決定事項・アクションアイテムの抽出
     │   ├─ 要約の生成（エグゼクティブサマリー）
     │   └─ 話者ごとの発言まとめ
     │
     ├─③ 議事録テンプレートへの整形
     │   └─ Markdown / PDF形式での出力
     │
     └─④ 結果をDBに保存 → 参加者への共有通知
```

**主要な技術的考慮事項**:
- 長時間会議（2時間超）の場合、音声を分割して並列処理
- Claude APIのコンテキスト長制限を考慮し、長い文字起こしはチャンク分割して処理
- リアルタイム文字起こし機能はPhase 2で対応（WebSocket + Transcribe Streaming）

---

## 4. セキュリティ・スケーラビリティ

### 4.1 認証・認可

| 項目 | 実装方式 |
|------|---------|
| **認証基盤** | Amazon Cognito（ユーザープール） |
| **認証方式** | メール/パスワード + ソーシャルログイン（Google Workspace連携） |
| **MFA** | TOTP（Google Authenticator等）対応。管理者アカウントは必須化 |
| **トークン管理** | JWT（アクセストークン: 15分、リフレッシュトークン: 7日） |
| **認可モデル** | RBAC（Role-Based Access Control）: オーナー、管理者、一般ユーザー、閲覧者 |
| **API認証** | API Gatewayでの Cognito Authorizer によるトークン検証 |

### 4.2 データ保護

| 項目 | 実装方式 |
|------|---------|
| **通信暗号化** | TLS 1.3（全通信をHTTPS化） |
| **保存時暗号化** | AWS KMS による AES-256暗号化（S3、RDS、ElastiCache） |
| **テナント分離** | Row-Level Security (RLS) + テナントIDによる論理分離 |
| **個人情報保護** | PIIデータのマスキング処理、ログからの除外 |
| **バックアップ** | Aurora の自動バックアップ（35日間保持）+ S3クロスリージョンレプリケーション |
| **監査ログ** | CloudTrail + アプリケーションレベルの操作ログ記録 |
| **電帳法対応** | タイムスタンプ付与、改変検知（ハッシュ値保存）、検索要件対応 |

### 4.3 マルチテナント設計

```
┌─────────────────────────────────────────────────┐
│              マルチテナント戦略                    │
│                                                 │
│  ┌─────────────────────────────────────┐        │
│  │  アプリケーション層: 共有インスタンス   │        │
│  │  - テナントIDによるリクエストスコープ   │        │
│  │  - ミドルウェアでテナントコンテキスト注入│        │
│  └─────────────────────────────────────┘        │
│                                                 │
│  ┌─────────────────────────────────────┐        │
│  │  データベース層: 共有DB + RLS         │        │
│  │  - 全テーブルに tenant_id カラム      │        │
│  │  - PostgreSQL RLSポリシーで強制分離   │        │
│  │  - Prismaミドルウェアで自動フィルタ    │        │
│  └─────────────────────────────────────┘        │
│                                                 │
│  ┌─────────────────────────────────────┐        │
│  │  ファイル層: S3プレフィックス分離      │        │
│  │  - s3://bucket/{tenant_id}/invoices/ │        │
│  │  - IAMポリシーでアクセス制御          │        │
│  └─────────────────────────────────────┘        │
│                                                 │
│  将来: 大規模テナントにはDB分離も検討             │
└─────────────────────────────────────────────────┘
```

### 4.4 スケーラビリティ設計

| 層 | スケーリング戦略 |
|----|-----------------|
| **フロントエンド** | CloudFront + S3による静的配信。オリジンへの負荷を最小化 |
| **API Gateway** | AWSマネージドで自動スケーリング。スロットリング設定でバースト対策 |
| **アプリケーション** | ECS Fargateのオートスケーリング（CPU/メモリベース + カスタムメトリクス） |
| **データベース** | Aurora のリードレプリカ追加。読み取りはレプリカに分散 |
| **キャッシュ** | ElastiCacheクラスターモード。ホットデータのキャッシュで DB負荷軽減 |
| **非同期処理** | SQSキュー + Fargateワーカーの自動スケーリング。キュー深度ベースで調整 |
| **AI処理** | APIレート制限を考慮したキュー制御。リトライ + エクスポネンシャルバックオフ |

**想定キャパシティ**:
- Phase 1（〜100社）: 単一インスタンス構成で十分
- Phase 2（〜1,000社）: オートスケーリング + リードレプリカ導入
- Phase 3（1,000社〜）: サービスメッシュ検討、DB分離検討

---

## 5. 開発フェーズとマイルストーン

### Phase 1: MVP（3ヶ月）

**目標**: コア機能の最小限実装でアーリーアダプターに提供

| 期間 | マイルストーン | 成果物 |
|------|-------------|--------|
| Month 1 | 基盤構築 | 認証基盤、テナント管理、CI/CDパイプライン、開発環境構築 |
| Month 2 | コア機能実装 | 請求書OCR処理（基本）、契約書アップロード・要約生成 |
| Month 3 | MVP完成 | UI統合、テスト、セキュリティレビュー、ベータ版リリース |

**Phase 1 の技術スコープ**:
- モノレポ構成（Turborepo）でフロント・バックエンドを管理
- 請求書処理と契約書管理の基本機能
- 基本的なRBAC（オーナー、一般ユーザー）
- 手動デプロイから自動デプロイへの段階的移行

### Phase 2: 機能拡張（3ヶ月）

**目標**: 議事録機能追加、UX改善、運用安定化

| 期間 | マイルストーン | 成果物 |
|------|-------------|--------|
| Month 4 | 議事録機能 | 音声アップロード、文字起こし、議事録自動生成 |
| Month 5 | 高度化 | 請求書バッチ処理、契約書リスク分析、全文検索 |
| Month 6 | 品質強化 | パフォーマンス最適化、監視強化（Datadog導入）、負荷テスト |

**Phase 2 の技術スコープ**:
- Amazon Transcribe統合（議事録機能）
- OpenSearch導入（全文検索）
- オートスケーリングの本格運用
- E2Eテスト自動化（Playwright）

### Phase 3: スケール（3ヶ月）

**目標**: エンタープライズ対応、外部連携、成長基盤構築

| 期間 | マイルストーン | 成果物 |
|------|-------------|--------|
| Month 7 | 外部連携 | freee / マネーフォワード連携、Slack連携、Webhook API |
| Month 8 | エンタープライズ | SSO（SAML）対応、監査ログ強化、IP制限、SLA保証 |
| Month 9 | 成長基盤 | 公開API提供、マルチリージョン検討、パフォーマンス最適化 |

**Phase 3 の技術スコープ**:
- 外部SaaSとのAPI連携基盤
- SAML/OIDC対応（エンタープライズSSO）
- APIゲートウェイの公開API対応
- 大規模テナント向けDB分離オプション

### 技術的負債への対応方針

各フェーズ終了時に「技術的負債スプリント」（1週間）を設け、以下を実施:
- コードリファクタリング
- 依存ライブラリのアップデート
- テストカバレッジの向上（目標: 80%以上）
- ドキュメント整備

---

## 補足: 技術選定の代替案と不採用理由

| カテゴリ | 代替案 | 不採用理由 |
|---------|--------|-----------|
| バックエンド言語 | Go / Rust | チーム立ち上げ速度を優先。TypeScript統一により学習コストを削減 |
| コンテナ基盤 | Kubernetes (EKS) | 初期フェーズでは過剰。Fargateで運用負荷を最小化し、必要時に移行 |
| データベース | DynamoDB | 請求書・契約書データはリレーショナルな参照が多く、RDBが適切 |
| AI基盤 | 自前モデルのトレーニング | 初期フェーズではAPIの利用で十分。自社モデルはPhase 3以降で検討 |
| フロントエンド | Vue.js / Angular | Reactエコシステムの充実度とNext.jsのSSR性能を重視 |
| 検索エンジン | Elasticsearch (自前運用) | OpenSearch Serviceによるマネージド運用で運用負荷を削減 |
